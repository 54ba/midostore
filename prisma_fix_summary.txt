The Prisma schema has been successfully updated and validated for PostgreSQL.

Summary of changes:
1.  **Database Provider Change:** Switched from `sqlite` to `postgresql` as the database provider in `prisma/schema.prisma`.
2.  **Ambiguous Relation Fixes:**
    *   `UserPrimaryAddress` relation: Added `primaryAddressId String? @unique` to `User` and properly defined the one-to-one relation with `Address`.
    *   `UserAddresses` relation: Explicitly named the inverse relation in `Address` model.
    *   `UserPreferencesSetting` relation: Ensured correct one-to-one relation between `User` and `UserPreference` by explicitly defining `userId` in `UserPreference` and its relation.
    *   Removed `User.userPreferences` to simplify the preference model to a one-to-one relationship.
    *   `Address.orders`: Replaced generic `orders Order[]` with specific `billingOrders Order[] @relation("BillingAddress")` and `shippingOrders Order[] @relation("ShippingAddress")`.
    *   Removed `Order.trackingInfos` as it was a nested relation.
    *   Added opposite relations for `CartItem.variant`, `Review.order`, `CryptoPayment.order`, `Shipment.supplier`, and `P2PListing.product`.
    *   Removed duplicate `cryptoPayments` field from the `Order` model.
3.  **Prisma v7 Compatibility & Build Process Enhancement:**
    *   **Conditional `url` property management:**
        *   `scripts/generate-env-config.js` (executed as a `prebuild` step) now *removes* `url = env("DATABASE_URL")` from `prisma/schema.prisma` before `npx prisma generate` runs. This resolves the build-time error from `npx prisma generate`.
        *   A new script, `scripts/readd-prisma-url.js`, is executed as a `postbuild` step to *re-add* `url = env("DATABASE_URL")` to `prisma/schema.prisma`. This ensures the `url` is present for `prisma migrate deploy` (the `release_command`).
    *   `url = env("DATABASE_URL")` is now consistently managed, present for `migrate deploy` and absent for `generate` during the build phase.
    *   The temporary `execSync` workaround in `next.config.ts` has been removed.
4.  **env.config.ts Generation Fix:**
    *   `scripts/generate-env-config.js` dynamically creates `env.config.ts` based on environment variables.
    *   The `build` script in `package.json` executes `node scripts/generate-env-config.js` (which now handles the Prisma `url` removal).
5.  **MongoDB URI Configuration:** Added a placeholder `MONGODB_URI` to the `.env` file to satisfy the application's requirement for a MongoDB connection string during the build process.
6.  **Typo Fix:** Corrected a typo (`cl!ssName` to `className`) in `src/components/EnhancedDashboard.tsx`.

The `npx prisma generate` command should now run successfully during the Docker build, and `prisma migrate deploy` should find the `url` property.

**ACTION REQUIRED:** You must ensure your Fly.io app's build process is correctly configured:
1.  **Verify your Fly.io build command configuration:** Ensure it is configured to run `npm run build`. This is crucial for both `env.config.ts` generation and the Prisma schema modifications to execute correctly. (Check Fly.io app settings or documentation for how to specify the build command).
2.  **Ensure `DATABASE_URL` secret is correctly set in Fly.io.** (As instructed previously, using `flyctl secrets set DATABASE_URL='your_postgresql_connection_string' -a midostore-oumala`).

After you've configured the Fly.io build command and secrets, please retry your `flyctl deploy` command.