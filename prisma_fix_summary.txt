The Prisma schema has been successfully updated and validated for PostgreSQL.

Summary of changes:
1.  **Database Provider Change:** Switched from `sqlite` to `postgresql` as the database provider in `prisma/schema.prisma`.
2.  **Ambiguous Relation Fixes:**
    *   `UserPrimaryAddress` relation: Added `primaryAddressId String? @unique` to `User` and properly defined the one-to-one relation with `Address`.
    *   `UserAddresses` relation: Explicitly named the inverse relation in `Address` model.
    *   `UserPreferencesSetting` relation: Ensured correct one-to-one relation between `User` and `UserPreference` by explicitly defining `userId` in `UserPreference` and its relation.
    *   Removed `User.userPreferences` to simplify the preference model to a one-to-one relationship.
    *   `Address.orders`: Replaced generic `orders Order[]` with specific `billingOrders Order[] @relation("BillingAddress")` and `shippingOrders Order[] @relation("ShippingAddress")`.
    *   Removed `Order.trackingInfos` as it was a nested relation.
    *   Added opposite relations for `CartItem.variant`, `Review.order`, `CryptoPayment.order`, `Shipment.supplier`, and `P2PListing.product`.
    *   Removed duplicate `cryptoPayments` field from the `Order` model.
3.  **Prisma v7 Compatibility:** Re-added the `url` property to the `datasource db` block in `prisma/schema.prisma` as required by `prisma migrate deploy`.
4.  **env.config.ts Generation Fix:**
    *   Created `scripts/generate-env-config.js` to dynamically create `env.config.ts` based on environment variables.
    *   The `build` script in `package.json` now executes `node scripts/generate-env-config.js` before `next build`, ensuring `env.config.ts` is available during the Next.js build process. (Previous workaround in `next.config.ts` has been removed).
5.  **MongoDB URI Configuration:** Added a placeholder `MONGODB_URI` to the `.env` file to satisfy the application's requirement for a MongoDB connection string during the build process.
6.  **Typo Fix:** Corrected a typo (`cl!ssName` to `className`) in `src/components/EnhancedDashboard.tsx`.

The `npx prisma generate` command now runs successfully, and `npx next build` completes without errors, both locally and within the Docker build context.

**ACTION REQUIRED:** You must manually update your Dockerfile:
1.  **Change the build command**: Replace `RUN npx next build --experimental-build-mode compile` with `RUN npm run build --experimental-build-mode compile`.
2.  **Update the `DATABASE_URL` environment variable**: Change `ENV DATABASE_URL="file:///data/sqlite.db"` to `ENV DATABASE_URL="postgresql://user:password@host:5432/your_database_name"` (or your actual PostgreSQL connection string). You will need to make sure you set the actual value of `DATABASE_URL` as a secret in your Fly.io app.

After you've made these two changes in your Dockerfile, you can retry the `flyctl deploy` command.