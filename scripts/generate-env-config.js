const fs = require('fs');
const path = require('path');

const prismaSchemaPath = path.resolve(__dirname, '../prisma/schema.prisma');
let prismaSchemaContent = fs.readFileSync(prismaSchemaPath, 'utf8');

// Temporarily remove 'url = env("DATABASE_URL")' for prisma generate
const newPrismaSchemaContent = prismaSchemaContent.replace(
  /(\s*provider = "postgresql")(\s*url\s*=\s*env\("DATABASE_URL"\))/,
  '$1'
);

// Only write if there are changes to avoid unnecessary file writes
if (newPrismaSchemaContent !== prismaSchemaContent) {
  fs.writeFileSync(prismaSchemaPath, newPrismaSchemaContent);
  console.log('✅ Temporarily removed DATABASE_URL from prisma/schema.prisma for generate.');
}

// Existing env.config.ts generation logic here
const outputPath = path.resolve(__dirname, '../env.config.ts');
const templatePath = path.resolve(__dirname, '../env-template.txt');

// Read the template file
const template = fs.readFileSync(templatePath, 'utf8');

// Basic extraction of variable names from the template
const varNames = [...new Set(Array.from(template.matchAll(/\${(.*?)}/g)).map(m => m[1]))];

let envConfigContent = `// This file is generated by scripts/generate-env-config.js
// Do not edit this file directly.

const envConfig = {
`;

varNames.forEach(varName => {
  const safeVarName = varName.replace(/[^a-zA-Z0-9_]/g, '');
  envConfigContent += `  ${safeVarName}: process.env.${varName} || '${process.env[varName] || ''}',\n`;
});

envConfigContent += `  NODE_ENV: process.env.NODE_ENV || 'development',\n`;
envConfigContent += `  NEXT_PORT: process.env.NEXT_PORT || '3000',\n`;
envConfigContent += `  NEXT_HOST: process.env.NEXT_HOST || 'localhost',\n`;
envConfigContent += `  API_PORT: process.env.API_PORT || '8000',\n`;
envConfigContent += `  API_HOST: process.env.API_HOST || '0.0.0.0',\n`;
envConfigContent += `  PYTHON_PATH: process.env.PYTHON_PATH || 'python3',\n`;
envConfigContent += `  VENV_PATH: process.env.VENV_PATH || './ai/venv',\n`;
envConfigContent += `  DATABASE_URL: process.env.DATABASE_URL || '',\n`;
envConfigContent += `  DATABASE_TYPE: process.env.DATABASE_TYPE || 'postgresql',\n`;
envConfigContent += `  LOG_LEVEL: process.env.LOG_LEVEL || 'INFO',\n`;
envConfigContent += `  ENABLE_AI_TRAINING: process.env.ENABLE_AI_TRAINING === 'true',\n`;

envConfigContent += `};

export const config = envConfig;
export default envConfig;
`;

fs.writeFileSync(outputPath, envConfigContent);
console.log(`✅ Generated ${outputPath}`);